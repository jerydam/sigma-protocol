"use strict";exports.id=2104,exports.ids=[2104],exports.modules={82104:(a,b,c)=>{c.d(b,{ReownAuthentication:()=>l});var d=c(65153),e=c(18259),f=c(60259),g=c(22513),h=c(46714),i=c(4106),j=c(21324);class k{constructor(a){this.getNonce=a.getNonce}async createMessage(a){let b={accountAddress:a.accountAddress,chainId:a.chainId,version:"1",domain:"undefined"==typeof document?"Unknown Domain":document.location.host,uri:"undefined"==typeof document?"Unknown URI":document.location.href,resources:this.resources,nonce:await this.getNonce(a),issuedAt:this.stringifyDate(new Date),statement:void 0,expirationTime:void 0,notBefore:void 0};return Object.assign(b,{toString:()=>this.stringify(b)})}stringify(a){let b=this.getNetworkName(a.chainId);return[`${a.domain} wants you to sign in with your ${b} account:`,a.accountAddress,a.statement?`
${a.statement}
`:"",`URI: ${a.uri}`,`Version: ${a.version}`,`Chain ID: ${a.chainId}`,`Nonce: ${a.nonce}`,a.issuedAt&&`Issued At: ${a.issuedAt}`,a.expirationTime&&`Expiration Time: ${a.expirationTime}`,a.notBefore&&`Not Before: ${a.notBefore}`,a.requestId&&`Request ID: ${a.requestId}`,a.resources?.length&&a.resources.reduce((a,b)=>`${a}
- ${b}`,"Resources:")].filter(a=>"string"==typeof a).join("\n").trim()}getNetworkName(a){let b=h.W.getAllRequestedCaipNetworks();return j.L.getNetworkNameByCaipNetworkId(b,a)}stringifyDate(a){return a.toISOString()}}class l{constructor(a={}){this.otpUuid=null,this.listeners={sessionChanged:[]},this.localAuthStorageKey=a.localAuthStorageKey||d.Ws.SIWX_AUTH_TOKEN,this.localNonceStorageKey=a.localNonceStorageKey||d.Ws.SIWX_NONCE_TOKEN,this.required=a.required??!0,this.messenger=new k({getNonce:this.getNonce.bind(this)})}async createMessage(a){return this.messenger.createMessage(a)}async addSession(a){let b=await this.request({method:"POST",key:"authenticate",body:{data:a.data,message:a.message,signature:a.signature,clientId:this.getClientId(),walletInfo:this.getWalletInfo()},headers:["nonce","otp"]});this.setStorageToken(b.token,this.localAuthStorageKey),this.emit("sessionChanged",a),this.setAppKitAccountUser(function(a){let b=a.split(".");if(3!==b.length)throw Error("Invalid token");let c=b[1];if("string"!=typeof c)throw Error("Invalid token");let d=c.replace(/-/gu,"+").replace(/_/gu,"/");return JSON.parse(atob(d.padEnd(d.length+(4-d.length%4)%4,"=")))}(b.token)),this.otpUuid=null}async getSessions(a,b){try{if(!this.getStorageToken(this.localAuthStorageKey))return[];let c=await this.request({method:"GET",key:"me",query:{},headers:["auth"]});if(!c)return[];let d=c.address.toLowerCase()===b.toLowerCase(),e=c.caip2Network===a;if(!d||!e)return[];let f={data:{accountAddress:c.address,chainId:c.caip2Network},message:"",signature:""};return this.emit("sessionChanged",f),this.setAppKitAccountUser(c),[f]}catch{return[]}}async revokeSession(a,b){return Promise.resolve(this.clearStorageTokens())}async setSessions(a){if(0===a.length)this.clearStorageTokens();else{let b=a.find(a=>a.data.chainId===(0,i.kg)()?.caipNetworkId)||a[0];await this.addSession(b)}}getRequired(){return this.required}async getSessionAccount(){if(!this.getStorageToken(this.localAuthStorageKey))throw Error("Not authenticated");return this.request({method:"GET",key:"me",body:void 0,query:{includeAppKitAccount:!0},headers:["auth"]})}async setSessionAccountMetadata(a=null){if(!this.getStorageToken(this.localAuthStorageKey))throw Error("Not authenticated");return this.request({method:"PUT",key:"account-metadata",body:{metadata:a},headers:["auth"]})}on(a,b){return this.listeners[a].push(b),()=>{this.listeners[a]=this.listeners[a].filter(a=>a!==b)}}removeAllListeners(){Object.keys(this.listeners).forEach(a=>{this.listeners[a]=[]})}async requestEmailOtp({email:a,account:b}){let c=await this.request({method:"POST",key:"otp",body:{email:a,account:b}});return this.otpUuid=c.uuid,this.messenger.resources=[`email:${a}`],c}confirmEmailOtp({code:a}){return this.request({method:"PUT",key:"otp",body:{code:a},headers:["otp"]})}async request({method:a,key:b,query:c,body:d,headers:f}){let{projectId:g,st:h,sv:i}=this.getSDKProperties(),j=new URL(`${e.o.W3M_API_URL}/auth/v1/${String(b)}`);j.searchParams.set("projectId",g),j.searchParams.set("st",h),j.searchParams.set("sv",i),c&&Object.entries(c).forEach(([a,b])=>j.searchParams.set(a,String(b)));let k=await fetch(j,{method:a,body:d?JSON.stringify(d):void 0,headers:Array.isArray(f)?f.reduce((a,b)=>{switch(b){case"nonce":a["x-nonce-jwt"]=`Bearer ${this.getStorageToken(this.localNonceStorageKey)}`;break;case"auth":a.Authorization=`Bearer ${this.getStorageToken(this.localAuthStorageKey)}`;break;case"otp":this.otpUuid&&(a["x-otp"]=this.otpUuid)}return a},{}):void 0});if(!k.ok)throw Error(await k.text());return k.headers.get("content-type")?.includes("application/json")?k.json():null}getStorageToken(a){return d.Ud.getItem(a)}setStorageToken(a,b){d.Ud.setItem(b,a)}clearStorageTokens(){this.otpUuid=null,d.Ud.removeItem(this.localAuthStorageKey),d.Ud.removeItem(this.localNonceStorageKey),this.emit("sessionChanged",void 0)}async getNonce(){let{nonce:a,token:b}=await this.request({method:"GET",key:"nonce"});return this.setStorageToken(b,this.localNonceStorageKey),a}getClientId(){return g.T.state.clientId}getWalletInfo(){let a=h.W.getAccountData()?.connectedWalletInfo;if(!a)return;if("social"in a&&"identifier"in a)return{type:"social",social:a.social,identifier:a.identifier};let{name:b,icon:c}=a,d="unknown";switch(a.type){case"EXTERNAL":case"INJECTED":case"ANNOUNCED":d="extension";break;case"WALLET_CONNECT":d="walletconnect";break;default:d="unknown"}return{type:d,name:b,icon:c}}getSDKProperties(){return f.N._getSdkProperties()}emit(a,b){this.listeners[a].forEach(a=>a(b))}setAppKitAccountUser(a){let{email:b}=a;b&&Object.values(e.o.CHAIN).forEach(a=>{h.W.setAccountProp("user",{email:b},a)})}}}};